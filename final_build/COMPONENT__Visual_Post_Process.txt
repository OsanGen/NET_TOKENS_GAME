Component: Visual Post Process
Purpose:
Own the full visual pipeline for all scenes:
- Render internal scene into an offscreen world buffer.
- Compose that buffer into the display with deterministic scaling.
- Apply mode-driven scanline/noise/chromatic overlays and profile-based detail budgets.
Gameplay simulation, collision checks, and hooks remain unchanged.

Inputs:
- World scene dimensions: `SIM_W=640`, `SIM_H=360`.
- Internal render scale: `INTERNAL_RENDER_SCALE=4` (offscreen scene buffer).
- Display canvas geometry (`canvas.width`, `canvas.height`, DPR-aware sizing).
- `state.mode`
- `state.frame`, `state.seed`
- `state.visual`:
  - `renderQualityMode`
  - `scaleMode`
  - `accentLead`
  - `contrastMode`
  - `fxProfile`
  - `fxFrame`
  - `vfxPreset` (`cinematic`, `neon`, `minimal`)
  - `visualProfile` (`premium` | `standard` | `low`)
  - `visualProfileAuto`
  - `frameWarnings` / `frameWarningLimit`
  - `modeTransition`
- Deterministic helpers: `frameNoise`, `sceneTone`, `accentColor`, `withAlpha`, `sceneTone`.

Outputs:
- A single frame rendered into `#game-canvas` with:
  - deterministic near-integer scale policy for crisp pixels,
  - readable, tone-driven overlays,
  - profile-aware scanline/noise/particle/bloom intensity,
  - optional reduced-motion scaling for motion-heavy FX.
- External API stability: `window.render_game_to_text()` and `window.advanceTime(ms)` continue unchanged.

State model:
- Draw-time only; no gameplay simulation mutation.
- Scene canvas remains `SIM_W * INTERNAL_RENDER_SCALE` with transform-based world coordinate space.
- `renderQualityMode` defaults to `nearest` when unspecified.
- `state.visual` visual-specific fields used at compose time:
  - `fxProfile`
  - `vfxPreset`
  - `visualProfile`
  - `visualProfileAuto`
  - `fxFrame`
  - `routePulsePhase`
  - `hubPulseOffset`
  - `battleImpactBurst`
  - `battleImpactSide`
  - `battleHud`
  - `modeTransition`
  - `frameWarnings`
- Internal post-process buffers:
  - `postFxCanvas` (`640x360`)
  - `postFxCtx`
  - `postFxImageData`

Visual preset layer:
- `VISUAL_PRESETS` defines three styles:
  - `cinematic`
  - `neon`
  - `minimal`
- `resolveModeVfxProfile()` merges mode profile with preset + quality tiers.
- `resolveActiveVfxProfile()` also applies transition blends from `state.visual.modeTransition`.
- `resolveVisualQualityMode()` auto-shifts `premium`/`standard`/`low` based on frame budget when `visualProfileAuto` is enabled.
- `resolvePostProcessSourceCanvas()` applies deterministic chromatic channel splitting when `chromaShift > 0`.
- `cycleVisualPreset()` (`V` key) and `cycleVisualQualityProfile()` (`P` key) mutate profile state.

Render-quality policy:
- Scene context:
  - `sceneCtx.setTransform(INTERNAL_RENDER_SCALE,0,0,INTERNAL_RENDER_SCALE,0,0)` each frame.
  - `sceneCtx.imageSmoothingEnabled` follows policy.
- Post compose:
  - `rawScale = min(canvasW/SIM_W, canvasH/SIM_H)`
  - integer snapping in nearest mode with overflow tolerance from pipeline config.
  - `smooth` mode only when requested.
  - `drawPostProcess()` applies `motionEnvelope` to limit jitter/beats under reduced-motion preference.

Brand + overlay contract:
- Tone governor enforces `sceneTone(mode)` for all overlay surfaces and accents.
- `withAlpha` applies deterministic RGB/RGBA normalization for safe contrast.
- `assertSingleAccent()` and `assertReadableContrast()` run in `render()`.
- Overlay text remains compact and sparse; gameplay status/action text is primarily externalized to DOM HUD cards.
- CSS is externalized in `styles.css` through `.hud-panel`, `.hud-chip`, `.hud-badges`, `.hud-console-list`, and state classes (`.is-critical`, `.is-warning`, `.is-ready`, `.is-muted`, `.is-digital`).
- Reduced-motion is dual-bound:
  - JS envelope clamp in `drawPostProcess()`.
  - `motion-reduced` / `prefers-reduced-motion` in CSS.

Mode animation stack:
- Mission:
  - parallax stars
  - objective halo and sector/route field motion
  - deterministic comet lanes
  - beacon sweep cue
- Hub:
  - focus pulse
  - route flow markers and node indicators
  - ship orbit halo
- Battle:
  - lane streaks
  - impact bursts
  - turn pulse strip
- Title/Result:
  - ambient pulse and minimal scanline/noise envelope
 - Sprite polish pass (new this turn):
   - subpixel sprite jitter for hostile micro-motion
   - per-entity faint outline/ring and shadow haze before post-process layering
   - tiny entity-side drift particles for alien units while maintaining sprite silhouette
   - optional sprite edge tinting controlled by entity tone and active mode
- Post-process overlay additions:
  - preset-aware particle drift
  - preset-aware radial bloom
  - chromatic split (`resolvePostProcessSourceCanvas`)
  - scanline and noise density scaling

Dependencies:
- `/Users/abelsanchez/CODEX/NEWGAME/game.js`
- `/Users/abelsanchez/CODEX/NEWGAME/styles.css`

Key helper surfaces:
- `resolveModeVfxProfile()`
- `resolveActiveVfxProfile()`
- `resolveVisualQualityMode()`
- `cycleVisualPreset()`
- `cycleVisualQualityProfile()`
- `drawPostProcess()`
- `drawModeEffectsEnvelope()`
- `drawPostProcessParticleCloud()`
- `drawPostProcessBloom()`
- `resolvePostProcessSourceCanvas()`
- `drawModeFrameChrome()`
- `drawPalettePulseBands()`
- `drawHubRouteFlow()`
- `drawMissionObjectiveHalo()`
- `drawMissionSectorField()`
- `drawMissionBeaconSweep()`
- `drawMissionCometLanes()`
- `drawMissionStatusStrip()` (legacy helper; status now surfaced via HUD)
- `drawSpriteByKey()` (supports optional sprite overlay tint + subpixel pass options)
- `drawSpriteEntity()` (now applies micro-atmosphere effects for every rendered sprite)
- `resolveSpriteRenderOffset()`
- `resolveSpriteAccent()`
- `drawSpriteMicroAtmosphere()`
- `drawBattleFocusLanes()`
- `drawBattleImpactStreak()`
- `drawBattleTurnPulse()`
- `drawPostProcessChromaticBleed({ scale })` guard path
- `prefersReducedMotion()`, `applyReducedMotionState()`, `bindReducedMotionPreference()`
- `state.visual.battleHud` (`enemyHp`, `playerHp`) interpolation for battle HP bars

Acceptance checks:
- `drawPostProcessChromaticBleed()` defends against undefined `scale` by defaulting to `1`.
- `render_game_to_text()` includes visual profile + frame budget metrics in `ui.metrics` and `ui.brand`.
- Playwright smoke emits fresh shots/states without schema regressions.
- Chromatic split remains deterministic for fixed seed and frame.
- Visual profile transitions (`premium|standard|low`) produce observable and measurable output differences without breaking frame progress.
- Reduced-motion user preference significantly lowers motion envelope, but does not remove readability affordances.
- Entity render micro-atmosphere does not alter gameplay collision/logic and remains visually bounded (no alpha or sprite extent exceeds 20% of entity radius).
- Sprite enhancement pass (`drawSpriteMicroAtmosphere`) degrades safely into fallback render path when vector mode is active.
