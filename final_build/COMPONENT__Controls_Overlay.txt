Component: Controls Overlay
Purpose:
Keep gameplay controls, mode status, and mission telemetry in a split external HUD layout (right telemetry rail + bottom command rail) while preserving a premium, highly legible frame around the canvas.
The overlay must stay readable at a glance, remain synchronized every frame, and never mutate gameplay state.
The layout must also remain compact enough to fit within viewport bounds on common laptop heights.

Visual contract:
- Shell chrome and HUD panels must feel modern and intentional across desktop/mobile.
- Start/goal/metric text must remain high-contrast against animated glow layers.
- Help toggle, action list, and mission telemetry must remain scannable with reduced-motion set.
- Layout must remain contained in viewport with no right-column spill; long action lists belong in the bottom command rail.
- OSAN proof-first constraints apply: low decoration weight, minimal gradients, restrained accent coverage, and content-first hierarchy.
- Visual state should be mode/preset-reactive and deterministic (no random chrome flicker).
- Visual color system must be token-driven (`styles.css` custom properties) so mode changes only swap token values, not selector structure.
- Additional animation layers should remain subtle, deterministic, and readable even on battery-constrained/mobile targets.
- Current visual direction is intentionally radical and obvious to non-technical viewers:
  - clipped command-frame geometry, brighter cyan/mint/amber palette, and stronger hero hierarchy.
  - shell and HUD chrome should read as enterprise dashboard + premium game, not retro flat panel.

Inputs:
- Mode (`title`, `hub`, `mission`, `battle`, `result`).
- HUD state from:
  - `state.ui.helpVisible`
  - `state.ui.helpPinned`
- `state.ui.autoHelpUntilFrame`
- `state.ui.firstMissionHelpShown`
- Mode context from:
  - `contextActionsForMode()`
  - `objectiveHintText()`
- Action context from:
  - `externalActionsForMode()`
  - `resolveBattleActionsForMode()`
- Metrics contract from:
  - `syncModeMetricsPayload()`.
- `styles.css` visual classes:
  - `.page-shell`, `.game-shell`, `.shell-ornament-*`
  - `.controls-panel`, `.controls-bottom`, `.hud-panel`
  - `.controls-actions`, `.hud-console-list`
  - `#start-btn`
- OSAN design standard file:
  - `/Volumes/data/Online/OSAN Visual System v2 — CogSec Pastel (45).txt`
- Structural shell classes:
  - `.command-shell`
  - `.command-stage`
- New animated chrome keys:
  - `actionStream`, `actionPulse`, `badgeSweep`, `panelShimmer`, `statusSlide`, `cmdGlow`
- JS chrome-state hooks:
  - `body[data-game-mode]`
  - `body[data-visual-preset]`
  - `body[data-motion-state]`
- `body[data-visual-tier]`
- `body[data-ui-tier]`
- Decorative shell markup from `index.html`:
  - `.shell-ornament.shell-ornament-left`
  - `.shell-ornament.shell-ornament-right`
  - `.command-shell`
  - `.command-stage`

Outputs:
- External controls in DOM:
  - `#controls-panel` (right telemetry rail)
  - `#controls-bottom` (bottom command rail)
- `#controls-actions` (rendered in bottom rail)
- `#controls-objective` (rendered in bottom rail)
- Structured HUD panels in DOM:
  - `#hud-intro`
  - `#hud-objective`
  - `#hud-threat`
  - `#hud-missions`
- `#hud-console`
- Render contract in `render_game_to_text().ui.metrics`:
  - `phase`
  - `threatScore`
  - `objectiveProgress`
  - `enemyCount`
  - `comboHint`
  - `cooldownState`
  - `frameBudget`
- Visual chrome render:
  - Canvas frame shell and start CTA in DOM with modern chrome (`#game-shell`, `#start-btn`).
  - Left/right shell ornaments visible and static at the panel corners.
- Removed legacy noise surfaces:
  - `#controls-foot` is deleted.
  - `.status-strip` footer is deleted.

State:
- `state.ui.helpVisible`: current manual visibility state.
- `state.ui.helpPinned`: manual override for auto-help behavior.
- `state.ui.autoHelpUntilFrame`: initial visibility window.
- `state.ui.firstMissionHelpShown`: mission onboarding gate.
- DOM refs:
  - `#controls-toggle`
  - `#controls-actions`
  - `#controls-objective`
  - `hudNodes` map for all `#hud-*` metrics.

Behavior:
- `syncExternalControlsUI()` is the single source of truth for overlay state.
- `H` key and `#controls-toggle` route through the same visibility path and sync panel state via `data-expanded`.
- Keyboard-first interaction contract:
  - `Tab` cycles primary actions in document order: canvas focus → side telemetry rail → bottom command rail.
  - Left/right arrows are the preferred traversal for `.controls-actions` siblings; up/down remain contextual for stacked mission/battle nested rows when present.
  - Enter/Space triggers the focused action; Escape closes transient help/action tooltips without moving mode.
  - `syncExternalControlsUI()` must keep `aria-expanded` and data attributes coherent so assistive traversal does not leave visual state behind.
- Split layout contract:
  - right panel holds context/objective/threat/mission/console telemetry,
  - bottom rail holds mode actions + objective hint + shortcut row.
- Compactness contract:
  - reduced panel/card paddings and typography scale for dense but readable presentation.
  - action chips in bottom rail are single-line with ellipsis to avoid overflow-driven height growth.
- `externalActionsForMode()` filters out redundant `H: help` action from in-panel action list.
- `resolveBattleActionsForMode()` reads move options from active player pet and marks selected entry.
- `syncModeMetricsPayload()` produces a stable UI snapshot and scene-aware label strings.
- `syncHudTextNode()` + `updateHudNodeClass()` apply class states (`.is-critical`, `.is-warning`, `.is-ready`, `.is-muted`, `.is-digital`) to threat and action chips.
- `hudNodes.consoleLines` keeps the last 2–3 console messages and stays fixed-height.
- `styles.css` now applies a layered glass and neon panel system:
  - dynamic shell backplate gradient pass,
  - panel borders and pseudo-element glow,
  - ornament rings around gameplay canvas,
  - interactive action-row hover/selection polish,
  - animated focus treatment for `#start-btn`.
- Latest style pass replaces the previous look with a visibly distinct dashboard language:
  - `Sora` + `Manrope` typography stack.
  - clipped-corner game shell with high-contrast frame edges.
  - stronger CTA treatment and brighter, mode-sensitive shell borders.
  - restrained ambient grid + sweep animations with reduced-motion compatibility.
- `styles.css` now uses a deeper tokenized chroma layer:
  - game shell gradients, shell ornaments, ambient background wash, CTA tones, panel scan speeds, and strip/chip glow all flow from `:root` tokens and preset overrides.
- Dynamic animation controls are tokenized per preset/mode:
  - `--shell-scan-speed`, `--game-shell-scan-speed`, `--shell-halo-speed`, `--shell-orbit-speed`
  - `--panel-pulse-speed`, `--status-slide-speed`, `--action-stream-speed`, `--cta-sheen-speed`, `--cta-beat-speed`
- `syncExternalControlsUI()` now publishes mode/preset/motion state to `<body>` attributes used by CSS:
  - `data-game-mode` for mode-aware panel and CTA chrome.
  - `data-visual-preset` for shell and control palette adaptation.
  - `data-motion-state` for reduced-motion fallback behavior.
- `syncExternalControlsUI()` now publishes tiered visual state:
  - `data-visual-tier` for full mode/preset/profile-mode signal.
  - `data-ui-tier` for manual-vs-auto profile intent.
- No standalone bottom shortcut/status bars are rendered; operational hints stay inside the existing mode action rail to reduce chrome noise.

Behavior in-game:
- Drawn HUD inside canvas is minimal (compact emergency strip only) while full mission/action/completion context is external.
- In-mission and battle objective detail remains visible in `#hud-objective`, `#hud-missions`, and `#hud-console`.
- `drawMissionStatusStrip()` remains inactive so objective/status copy is not duplicated on the canvas.

Edge Cases:
- If expected DOM nodes are missing, synchronization fails open with no gameplay mutation.
- Mobile layouts stack in this order: canvas, bottom command rail, right telemetry rail.
- Long action labels in battle mode must truncate safely without breaking grid flow.
- Reduced-motion preference applies to animation-heavy UI classes via CSS class hook.
- If browser animation is disabled, the overlay must still remain readable with all pseudo-element glow and pulse effects effectively static.
- On narrow viewports, the `.controls-actions` two-column layout should not wrap mission actions beyond visible bounds.
- Preset transitions should keep animation duration behavior consistent (e.g., minimal style does not animate chrome layers aggressively).
- New:
  - 390px and 768px layouts should preserve contrast for status chips and keep start CTA tappable.
  - shell ornaments remain visible and symmetric in compact layouts.
  - `body[data-motion-state="reduced"]` and desktop `prefers-reduced-motion` should suppress high-frequency effects while preserving baseline structure.
- Focus containment and spill prevention:
  - Horizontal action rail overflow must stay inside `#controls-bottom` without horizontal page scroll.
  - Focus order never jumps outside the two-rail command UI while active mode is not result.
  - On battle mode, action list focus ring should remain visible under reduced opacity shell states.

Dependencies:
- `/Users/abelsanchez/CODEX/NEWGAME/game.js`
- `/Users/abelsanchez/CODEX/NEWGAME/index.html`
- `/Users/abelsanchez/CODEX/NEWGAME/styles.css`

Acceptance Checks:
- Directional control expectation check:
  - Primary action rail navigation: left/right arrow traverses between available actions.
  - Up/down navigation reserved for nested or popup action contexts only; no accidental directional hijack in flat rails.
  - Pressing Tab should not skip visible command elements on either viewport.
- Overflow resilience:
  - action lane width clamp never exceeds parent rail width by >2%.
  - bottom rail remains below the 35% viewport height cap on 768px-tall displays.
- `H` and `#controls-toggle` immediately update panel expanded state and hide/show the bottom command rail.
- Desktop layout keeps the side telemetry rail bounded (scrollable if needed) with no page spill.
- Bottom actions rail remains visible on one screen with reduced card height on battle mode.
- Legacy noise surfaces (`#controls-foot`, `.status-strip`) are absent from DOM and styles.
- Mode transitions (title→hub→mission→result) update action/objective/console text deterministically without gameplay changes.
- `.command-shell` and `.command-stage` wrappers exist without affecting HUD synchronization.
- At least 70% of control/status context is in DOM HUD (not canvas overlays).
- Threat/mission chips render state classes for instant readability.
- Keyboard and objective HUD remain visible during gameplay while keeping gameplay canvas visually uncluttered.
- Battle action list uses active player pet move options and visibly indicates selected move.
- `.page-shell`, `.controls-panel`, and `.hud-panel` styles include modern glass borders and layered gradient accents.
- `.shell-ornament-left` and `.shell-ornament-right` are both visible during normal and reduced-motion modes.
- `.controls-actions` hover/selected visuals still satisfy contrast constraints.
- Desktop shell chrome and mobile (390px/768px) remain legible and stable with reduced-motion preference active.
- Controls rail styling remains OSAN-compliant: subdued gradients, no glow-dominant effects, and content-first readability.
- Mode/preset transitions do not introduce layout jumps; only cosmetic motion/color tokens update.
- Visual comparison against pre-pass build is immediately noticeable without interaction.

Contract invariants:
- Action synchronization is deterministic:
  - same mode/input state must produce same action label ordering.
  - selected index must remain stable across frame when mode/action list unchanged.
- Keyboard mapping invariants:
  - flat rails use horizontal traversal first (`leftEdge`/`rightEdge`).
  - vertical traversal only for nested/submenu contexts.
  - confirm/cancel cannot skip or reorder action array.
- Synchronization invariants:
  - `syncExternalControlsUI()` must run at least once per render frame where UI-visible mode changes.
  - if `hudNodes.controls` or target nodes are missing, HUD sync degrades safely and logs once.
- Accessibility invariants:
  - `Tab` remains usable and never jumps out of command rails in active gameplay modes.
  - focus indicator is visible in both normal and reduced-motion visual states.

Failure handling:
- Missing `#controls-panel`:
  - keep gameplay running; suppress only external telemetry rendering to that panel.
- Missing `#controls-bottom`/`#controls-actions`:
  - keep control state in internal model for recovery and do not throw.
- Duplicate IDs or selector collisions:
  - one warning per session and fallback to deterministic first-match behavior.
- Rapid input burst:
  - directional edges remain bounded per frame.
  - no repeated confirm/cancel on held keys.

Cross-surface consistency:
- External overlay text payload and internal HUD text must align with gameplay state:
  - threat score
  - mission objective string
  - objective progress percentage
  - mode-specific hint string
- Preset transitions should not create stale action nodes; rebuild action nodes after style changes if list source changed.
- Visual chrome changes in `styles.css` must not require component-level selector refactor.

Performance constraints:
- UI sync work remains O(N) for number of HUD nodes/actions.
- No blocking DOM layout reads in inner loops for common frame rates.
- Action list re-render should be minimal by diffing when available; avoid full re-creation unless action payload length changes.

Diagnostics and observability:
- Debug flags:
  - `DEBUG_UI_SYNC` logs source/action count/state.
  - `DEBUG_ACTION_NAV` logs index transitions when navigation keys pressed.
- Ensure `render_game_to_text().ui.metrics` remains populated for scriptability.
- Capture and retain selector-contract snapshots in smoke outputs for regression comparison.

Acceptance extensions:
- Layout compliance:
  - no horizontal overflow at 390x844 and 1366x768.
  - no clipped action text when width contraction occurs (ellipsis only).
- Interaction reproducibility:
  - 100 fixed-frame input events reproduce same action sequence in non-random mode.
- Focus ring continuity:
  - entering/exiting help mode cannot blur or clear visible focus cues.
- Reliability:
  - one failed action node lookup does not remove entire panel state.
