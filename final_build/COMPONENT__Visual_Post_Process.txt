Component: Visual Post Process
Purpose:
Own the full visual pipeline for all scenes and keep HUD presentation in line with the current CogSec pastel scope:
- Render the internal scene buffer.
- Compose to the display at deterministic scale.
- Apply profile-driven overlays without grain-heavy effects.
- Keep visual quality knobs centralized and replayable by seed.
- Preserve gameplay logic and public API contract.

Inputs:
- World scene dimensions: `SIM_W=640`, `SIM_H=360`.
- Internal render scale: `INTERNAL_RENDER_SCALE=1`.
- Canvas geometry: `canvas.width`, `canvas.height` plus DPR-aware draw sizing.
- Game state:
  - `state.mode`
  - `state.visual`:
    - `renderQualityMode`
    - `scaleMode`
    - `accentLead`
    - `contrastMode`
    - `fxProfile`
    - `fxFrame`
    - `vfxPreset`
    - `visualProfile`
    - `visualProfileAuto`
    - `modeTransition`
    - `frameWarnings` / `frameWarningLimit`
    - `battleImpactBurst` / `battleImpactSide` / `battleImpactColor` / `battleImpactSeed` / `battleImpactSeverity`
    - `routePulsePhase` / `hubPulseOffset`
  - `state.seed`
  - `state.frame`
- Deterministic helpers and palettes:
  - `frameNoise`, `sceneTone`, `accentColor`, `withAlpha`, `toneTextShade`.

Outputs:
- A single composed frame in `#game-canvas` that is readable, low-cluttered, and color-disciplined.
- Consistent profile behavior across modes and presets.
- Preserved gameplay-facing contracts:
  - `window.render_game_to_text()`
  - `window.advanceTime(ms)`

State model:
- Draw-time only; no gameplay mutation.
- Scene pipeline buffers:
  - `scene` offscreen canvas at `SIM_W * INTERNAL_RENDER_SCALE`
  - `postFxCanvas` (`640x360`) for optional effects merge
  - `postFxImageData` scratch buffer
- Profile state tracks:
  - `state.visual.visualProfile`
  - `state.visual.vfxPreset`
  - `state.visual.visualProfileAuto`
  - `state.visual.lastFrameMs`
  - `state.visual.modeTransition`

Visual preset stack:
- `VISUAL_PRESETS`
  - `modern`
  - `minimal`
  - `cinematic`
  - `neon`
- Visual tier is read each frame through `resolveActiveVfxProfile()` and applied in one place.
- `resolveVisualPresetKey()` now drives styling hooks through body data attributes:
  - `data-visual-preset`
  - `data-game-mode`
  - `data-ui-tier`
  - `data-motion-state`

Modern preset behavior:
- `VISUAL_PRESET_ORDER` defaults to modern-first.
- Modern mode suppresses grain/noise-heavy legacy passes:
  - noise density and scanline intensity are bounded near-zero
  - frame jitter and flicker overlays are disabled in modern branch
  - no star envelope particles in modern mode
  - minimal atmosphere layering
  - no heavy chromatic bleed paths for modern branch
  - no heavy static wash artifacts
- `drawPostProcess()` uses an explicit modern envelope branch and modern shell overlay branch.

Render pipeline:
- Compose flow:
  1. `drawScene()` renders world primitives + sprites to `scene`.
  2. `drawWorldScene()` applies restrained base tone fill and subtle wash only.
  3. `drawPostProcess()` scales and places source into gameplay canvas.
  4. Envelope + shell overlays run according to active profile (`modern` / `minimal` / cinematic variants).
- Scaling policy:
  - `smooth` is now the default policy for the visual pipeline
  - nearest policy remains available via explicit `renderQualityMode` / `scaleMode` override
  - sprite draw points and glow fills use fractional placement when policy is `"smooth"`
  - this keeps sprites readable at higher internal scale without re-snapping artifacts
  - modern preset enforces integer sprite placement to avoid subpixel softness
- `INTERNAL_RENDER_SCALE=1` removes the previous high-multiple internal pixel scale and avoids the extra down-up sample path that could blur sprite/detail rendering.
- `VISUAL_SPRITE_SCALE` and `VISUAL_PLANET_SCALE` are increased (ship/planet scales) to increase in-world presence while leaving collision radii and gameplay balance intact.

Frame quality controls:
- `VISUAL_PIPELINE` defines global effect budgets.
- `VISUAL_QUALITY_PROFILES` drives automatic downgrade under pressure.
- `resolveVisualQualityMode()` applies profile auto-switching when `visualProfileAuto` is true.
- `resolveActiveVfxProfile()` merges mode profile + preset + transition blend + profile quality.

Brand + CSS interface:
- Styles for all visible surfaces live in `styles.css`:
  - `.page-shell`, `.hero-band`, `.command-shell`
  - `#game-shell`, `#game-canvas`, `.shell-ornament`
  - `.controls-panel`, `.hud-panel`, `.hud-chip`, `.hud-badges`, `.controls-actions`, `.status-strip`
  - `#start-btn`, `.is-critical`, `.is-warning`, `.is-ready`, `.is-muted`, `.is-digital`
- CSS now follows CogSec pastel rules:
  - White/Fog field first.
  - INK borders for structure.
  - one micro-accent color per mode via body attributes.

Reduced-motion safety:
- JS clamp in `drawPostProcess()` plus body dataset binding (`data-motion-state`) for all critical overlays.
- `prefers-reduced-motion` and `body.motion-reduced` disable non-critical animation loops.

Mode coverage:
- Title/HUB/Mission/Battle/Result share consistent shell and overlay grammar.
- `mission` and `battle` retain stronger action/readability markers without adding grain.
- `drawModeEffectsEnvelope()` has explicit modern branch to prevent accidental visual overload.
- Modern branch now returns immediately without particle envelope overlays.

Dependencies:
- `/Users/abelsanchez/CODEX/NEWGAME/game.js`
- `/Users/abelsanchez/CODEX/NEWGAME/styles.css`

Key helper surfaces:
- `resolveModeVfxProfile()`
- `resolveActiveVfxProfile()`
- `resolveVisualQualityMode()`
- `cycleVisualPreset()`
- `cycleVisualQualityProfile()`
- `drawPostProcess()`
- `drawModeEffectsEnvelope()`
- `drawPostProcessParticleCloud()`
- `drawPostProcessBloom()`
- `resolvePostProcessSourceCanvas()`
- `drawModeFrameChrome()`
- `drawPalettePulseBands()`
- `drawHubRouteFlow()`
- `drawMissionObjectiveHalo()`
- `drawMissionSectorField()`
- `drawMissionBeaconSweep()`
- `drawMissionCometLanes()`
- `drawSpriteByKey()`
- `drawSpriteEntity()`
- `resolveSpriteRenderOffset()`
- `resolveSpriteAccent()`
- `drawSpriteMicroAtmosphere()`
- `drawBattleFocusLanes()`
- `drawBattleImpactStreak()`
- `drawBattleImpactFlash()`
- `drawBattleTurnPulse()`
- `drawPostProcessChromaticBleed()`
- `drawWorldScene()`
- `applyReducedMotionState()`
- `bindReducedMotionPreference()`

Acceptance checks:
- Preset cycling and reduced-motion state are visibly reflected in DOM attributes and in CSS shells.
- Modern preset frame rendering is substantially cleaner vs previous versions (no grain shimmer, no heavy glows, no busy overlay clutter).
- Modern branch must show zero flicker/shimmer/jitter artifacts under baseline gameplay and fixed-viewport captures.
- Battle strike impact visuals are now two-part:
  - directional lane streak
  - flash ring + radial wash + deterministic sparklets
  - attacker species tint + intensity tiers derived from damage and reduced-motion-aware dampening
- Sprite overlay fallback branch bug for glow rendering is addressed by using the same draw coordinates as image blits, preventing misaligned alpha halos.
- One accent discipline holds:
  - decorative color is bounded to thin UI accents and chips.
- Accessibility baseline:
  - text contrast remains readable in major panels at default settings.
- External API remains stable (`render_game_to_text` and `advanceTime` unchanged).
- Motion intensity visibly lowers for reduced-motion context while layout/readability stay intact.
